<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ict.finalproject.dao.CrewDAO">

    <select id="usercodeSelect" resultType="int">
        select usercode
        from   user_tbl
        where  username = '${param1}'
    </select>

    <update id="crew_write_hit_update">
        update crew_write
        set
            hits=hits+1
        where create_crew_code = ${param1}
    </update>

    <select id="totalRecord" resultType="int">
        select count(b.create_crew_code)
        from  create_crew_tbl a, crew_write b
        where a.create_crew_code = b.create_crew_code
    </select>

    <select id="crew_name_check" resultType="int">
        select count(1)
        from  create_crew_tbl
        where crew_name = '${param1}'
    </select>

    <select id="crew_page_select" resultType="com.ict.finalproject.vo.CrewVO">
        select a.create_crew_code,a.crew_name,a.logo,${param1} as usercode,b.position as b_n,
        ifnull((select crew_write_code
        from    crew_write
        where   create_crew_code = b.create_crew_code
        and     is_delete = 0
        limit 1),0) as a_n
        from   create_crew_tbl a, crew_member_tbl b
        where  b.usercode = ${param1}
        and    a.create_crew_code=b.create_crew_code
    </select>

    <select id="crewSelectPaging" resultType="com.ict.finalproject.vo.CrewVO">
        select a.create_crew_code ,a.crew_name, a.logo, concat(a.addr,' ',a.addr_gu) as addr, b.gender, b.hits, b.age, b.content,b.crew_write_code
        ,(select count(1) from crew_member_tbl where create_crew_code = a.create_crew_code) as num
        ,(select count(1) from crew_request_tbl where create_crew_code=a.create_crew_code) as a_n
        from  create_crew_tbl a, crew_write b
        where b.is_delete = 0
        and   a.create_crew_code = b.create_crew_code
        group by a.create_crew_code ,a.crew_name, a.logo,concat(a.addr,' ',a.addr_gu), b.gender, b.hits, b.age, b.content, b.writedate ,a.create_crew_code,b.crew_write_code
        order by b.writedate desc
        limit 10 offset #{offset}
    </select>

    <select id="search_crewList" resultType="com.ict.finalproject.vo.CrewVO">
        select a.create_crew_code ,a.crew_name, a.logo, concat(a.addr,' ',a.addr_gu) as addr, b.gender, b.hits, b.age, b.content
        ,(select count(1) from crew_member_tbl where create_crew_code = a.create_crew_code) as num
        ,(select count(1) from crew_request_tbl where create_crew_code = a.create_crew_code) as a_n
        from create_crew_tbl a, crew_write b
        where b.is_delete = 0
        and a.create_crew_code = b.create_crew_code
        and b.gender like ifnull(concat('%', '${param3}', '%'), '%')
        and b.age like ifnull(concat('%', '${param4}', '%'), '%')
        and concat(a.addr,' ',a.addr_gu) like ifnull(concat('%', '${param5}', '%'), '%')
        and concat(a.addr,' ',a.addr_gu) like ifnull(concat('%', '${param6}', '%'), '%')
        and instr(concat(concat(a.addr,' ',a.addr_gu), '@', b.age, '@', b.gender, '@', b.content, '@', a.crew_name), ifnull('${param7}', '')) > 0
        group by a.create_crew_code, a.crew_name, a.logo, concat(a.addr,' ',a.addr_gu), b.gender, b.hits, b.age, b.content, b.writedate, a.create_crew_code
        order by ${param2} desc
        limit 10 offset ${param1}
    </select>
    <insert id="crew_insert">
        insert into create_crew_tbl
        (
            crew_name
            ,logo
            ,addr
            ,addr_gu
            ,gender
            ,content
            ,age
            ,usercode
        )
        values
        (
            '${param1}'
            ,'${param2}'
            ,'${param3}'
            ,'${param4}'
            ,'${param5}'
            ,'${param6}'
            ,'${param7}'
            ,${param8}
        );
    </insert>
    <insert id="crew_write_add">
        insert into crew_write
        (
             create_crew_code
            ,usercode
            ,teamPhoto
            ,age
            ,gender
            ,content
            ,writedate
            ,hits
        )
        values
        (
             ${param1}
            ,${param2}
            ,'${param3}'
            ,'${param4}'
            ,'${param5}'
            ,'${param6}'
            ,now()
            ,0
        );
    </insert>

    <select id="crew_write_detail_select" resultType="com.ict.finalproject.vo.CrewVO">
        select a.logo, a.crew_name, a.usercode, concat(a.gender,' · ',a.age) as a_s, b.teamPhoto as b_s
        , b.age, b.gender, b.content,b.hits,DATE_FORMAT(b.writedate, '%Y.%m.%d %H:%i') as writedate
        , concat(a.addr,' ',a.addr_gu) as addr, DATE_FORMAT(a.writedate, '%Y-%m-%d') as c_s,${param1} as b_n
        ,(select count(1)from crew_request_tbl where create_crew_code=a.create_crew_code and usercode=${param1} and status=0)as c_n
        ,(select count(1)from crew_member_tbl  where create_crew_code=${param2})as d_n
        ,(select avg(floor(datediff(curdate(), birthdate) / 365.25))from user_tbl a ,crew_member_tbl b where b.create_crew_code = ${param2} and a.usercode = b.usercode) as e_n
        ,(select position from crew_member_tbl where usercode=${param1} and create_crew_code=${param2}) as f_n
        ,(select count(1) from crew_member_tbl where create_crew_code=a.create_crew_code and usercode=${param1}) as g_n
        from   create_crew_tbl a, crew_write b
        where  a.create_crew_code = b.create_crew_code
        and    a.create_crew_code=${param2}
        and    b.is_delete = 0
    </select>
    <select id="crew_join_select" resultType="int">
        select count(1)
        from   crew_request_tbl
        where  create_crew_code = ${param2}
        and    usercode = ${param1}
        and    status   = 0
    </select>
    <select id="join_before_select" resultType="int">
        select count(1)
        FROM user_tbl u
        JOIN crew_write cw ON
        (cw.gender = '성별무관' OR
        (cw.gender = '남자' AND u.gender = '남') OR
        (cw.gender = '여자' AND u.gender = '여'))
        WHERE cw.crew_write_code = ${param2}
        AND (
        (cw.age LIKE '%10대%' AND TIMESTAMPDIFF(YEAR, u.birthdate, CURDATE()) BETWEEN 10 AND 19)
        OR
        (cw.age LIKE '%20대%' AND TIMESTAMPDIFF(YEAR, u.birthdate, CURDATE()) BETWEEN 20 AND 29)
        OR
        (cw.age LIKE '%30대%' AND TIMESTAMPDIFF(YEAR, u.birthdate, CURDATE()) BETWEEN 30 AND 39)
        OR
        (cw.age LIKE '%40대%' AND TIMESTAMPDIFF(YEAR, u.birthdate, CURDATE()) BETWEEN 40 AND 49)
        OR
        (cw.age LIKE '%50대%' AND TIMESTAMPDIFF(YEAR, u.birthdate, CURDATE()) BETWEEN 50 AND 59)
        OR
        (cw.age LIKE '%60대%' AND TIMESTAMPDIFF(YEAR, u.birthdate, CURDATE()) >= 60)
        )
        and u.usercode = ${param1};
    </select>
    <insert id="crew_join_write">

        insert into crew_request_tbl
        (
            usercode
            ,create_crew_code
            ,content
        )
        values
        (
             ${param1}
            ,${param2}
            ,'${param3}'
        )
    </insert>

    <delete id="crew_join_delete">
        delete from   crew_request_tbl
        where  create_crew_code = ${param2}
        and    usercode = ${param1}
    </delete>

    <update id="crew_write_delete">
        update crew_write
        set is_delete = 1,
        delete_date = now()
        where crew_write_code = ${param2}
    </update>
    <select id="crew_page_write_detail" resultType="com.ict.finalproject.vo.CrewVO">
        select addr,addr_gu,age,gender,crew_name
        from   create_crew_tbl a
        where  create_crew_code = ${param1};
    </select>
    <select id="crew_write_detail_check" resultType="com.ict.finalproject.vo.CrewVO">
        select teamPhoto,age,gender,content
        from   crew_write a
        where  crew_write_code = ${param1};
    </select>
    <update id="crew_write_update">
        update crew_write
        set    teamPhoto = '${param3}'
        ,age = '${param4}'
        ,gender = '${param5}'
        ,content = '${param6}'
        ,writedate = now()
        where crew_write_code = ${param1}
    </update>
    <select id="crew_code_select" resultType="int">
        select create_crew_code
        from   create_crew_tbl
        where  usercode = ${param1}
        order by writedate desc
        limit 1
    </select>
    <insert id="crew_member_insert">
        insert into crew_member_tbl
        (
            usercode
            ,create_crew_code
            ,position
        )
        values
        (
            ${param1}
            ,${param2}
            ,${param3}
        )
    </insert>

    <select id="crew_wait_select" resultType="com.ict.finalproject.vo.CrewVO">
        select a.logo, a.crew_name, b.status as a_n,a.create_crew_code, c.crew_write_code, b.crew_request_code as b_n
        from   create_crew_tbl a, crew_request_tbl b, crew_write c
        where  b.usercode = ${param1}
        and    a.create_crew_code = b.create_crew_code
        and    a.create_crew_code = c.create_crew_code
    </select>

    <select id="crew_wait_detail" resultType="com.ict.finalproject.vo.CrewVO">
        select content, DATE_FORMAT(requested_date, '%m월 %d일 신청') AS writedate,usercode, status as a_n,reason as a_s
        from   crew_request_tbl
        where  usercode = ${param1}
        and    create_crew_code  = ${param2}
        and    crew_request_code = ${param3}
    </select>

    <update id="update14">
    <![CDATA[
        update crew_request_tbl
        set status = 9
        where requested_date <= date_add(now(), interval -14 day);
    ]]>
    </update>

    <select id="crew_manage_member" resultType="com.ict.finalproject.vo.CrewVO">
        select ifnull(a.profile_img,'basicimg.png') as a_s, a.nickname as b_s, b.position as a_n, a.usercode,a.nickname
        ,(select count(1) from crew_member_tbl where create_crew_code = ${param1} and usercode = ${param2}) as b_n
        ,(select count(1)from crew_request_tbl crt where create_crew_code = ${param1} and status=0) as f_n
        from user_tbl a ,crew_member_tbl b
        where b.create_crew_code = ${param1}
        and   a.usercode = b.usercode
        order by position
    </select>

    <select id="crew_app_select" resultType="com.ict.finalproject.vo.CrewVO">
        <![CDATA[
            select a.nickname,
            case
            when timestampdiff(minute, b.requested_date , now()) < 1 then '방금 전'
            when timestampdiff(minute, b.requested_date, now()) < 60 then concat(timestampdiff(minute, b.requested_date, now()), '분 전')
            when timestampdiff(hour, b.requested_date, now()) < 24 then concat(timestampdiff(hour, b.requested_date, now()), '시간 전')
            else concat(timestampdiff(day, b.requested_date, now()), '일 전')
            end as a_s,
            a.gender,c.crew_name,b.crew_request_code as c_n
            ,timestampdiff(year, a.birthdate, curdate()) as b_s,a.addr,timestampdiff(year, a.birthdate, curdate()) as a_n, b.status as b_n
            ,b.usercode
            from  user_tbl a, crew_request_tbl b, create_crew_tbl c
            where b.create_crew_code =	${param1}
            and   a.usercode = b.usercode
            and   b.create_crew_code = c.create_crew_code
        ]]>
    </select>
    <update id="crew_manage_app">
        update crew_request_tbl
        set    status = ${param3},
               reason = '${param4}'
        where  usercode = ${param1}
        and    create_crew_code  = ${param2}
        and    crew_request_code = ${param5}
    </update>
    <insert id="crew_member_insert2">
        insert into crew_member_tbl
        (
            usercode
            ,create_crew_code
            ,position
        )
        values
        (
            ${param1}
            ,${param2}
            ,3
        )
    </insert>

    <select id="crew_member_check" resultType="int">
        select count(1)
        from   crew_member_tbl
        where  usercode = ${param1}
        and    create_crew_code = ${param2}
        and    position in (1,2,3)
    </select>

    <update id="crew_member_upgrade">
        update crew_member_tbl
        set    position = 2
        where  usercode = ${param1}
        and    create_crew_code = ${param2}
    </update>

    <update id="crew_member_downgrade">
        update crew_member_tbl
        set    position = 3
        where  usercode = ${param1}
        and    create_crew_code = ${param2}
    </update>

    <insert id="crew_member_report">
        insert into report_tbl
        (
        offender_code
        ,victim_code
        ,report_reason
        ,report_reason_text
        ,report_status
        )
        values
        (
        ${param1}
        ,${param2}
        ,'${param3}'
        ,'${param4}'
        ,'처리중'
        )
    </insert>
    <delete id="crew_member_out">
        delete from crew_member_tbl
        where  usercode = ${param1}
        and    create_crew_code = ${param2}
    </delete>

    <insert id="crew_history_insert">
        insert into crew_history_tbl
        (
            usercode
            ,creeate_crew_code
            ,flag
            ,withdrawaldate
        )
        values
        (
            ${param1}
            ,${param2}
            ,${param3}
            ,now()
        );
    </insert>
    <insert id="vote_create">
        insert into vote_tbl
        (
            usercode
            ,create_crew_code
            ,subject
            ,enddate
            ,opt1
            ,opt2
            ,opt3
            ,opt4
            ,opt5
        )
        values
        (
            ${param1}
            ,${param2}
            ,'${param3}'
            ,'${param4}'
            ,'${param5}'
            ,'${param6}'
            ,'${param7}'
            ,'${param8}'
            ,'${param9}'
        );
    </insert>

    <select id="crew_manage_overview" resultType="com.ict.finalproject.vo.CrewVO">
        <![CDATA[
        (
            select 0 as a_n,
                   ifnull(a.profile_img, 'basicimg.png') as subject,
                   a.nickname as writedate,
                   ${param2} as b_n,
                   (select count(1)
                    from crew_member_tbl
                    where create_crew_code = ${param1}) as c_n
            from user_tbl a, crew_member_tbl b
            where  a.usercode = b.usercode
            and b.create_crew_code = ${param1}
            order by b.position
            limit 4
        )
        union
        (
            select 1 as a_n, subject, creationdate as writedate,
                   case when enddate < now() then 9 else 1 end as b_n, 1 as c_n
            from vote_tbl
            where create_crew_code = ${param1}
            order by creationdate desc
            limit 1
        )
        union
        (
            select 2 as a_n, subject, writedate, 0 as b_n, 1 as c_n
            from crew_notice_tbl
            where create_crew_code = ${param1}
            order by writedate desc
            limit 3
        )

        ]]>
    </select>

</mapper>